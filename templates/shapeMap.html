<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Display Polygons and Points</title>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.30/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.30/"></script>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 99;
        background: white;
        padding: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <form id="upload-form" method="post" enctype="multipart/form-data">
        <input
          type="file"
          id="file-input"
          name="files"
          multiple
          webkitdirectory
          directory
        />
        <button type="submit">Upload and Display</button>
      </form>
      <!-- <div id="result"></div> -->
    </div>
    <div id="viewDiv"></div>
    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/Graphic",
        "esri/layers/GraphicsLayer",
        "esri/geometry/Polygon",
        "esri/geometry/Point",
      ], function (Map, MapView, Graphic, GraphicsLayer, Polygon, Point) {
        // Create a map
        var map = new Map({
          basemap: "streets",
        });

        // Create a view
        var view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-79.4637, 43.6465],
          zoom: 15,
          spatialReference: { wkid: 3857 },
        });

        // Create a GraphicsLayer and add it to the map
        var graphicsLayer = new GraphicsLayer();
        map.add(graphicsLayer);

        function addPolygonsAndPoints(polygons) {
          var combinedExtent = null;

          polygons.forEach(function (polygonCoordinates) {
            // Create a polygon geometry
            var polygon = new Polygon({
              rings: polygonCoordinates,
              spatialReference: { wkid: 3857 },
            });

            // Create a polygon graphic
            var polygonGraphic = new Graphic({
              geometry: polygon,
              symbol: {
                type: "simple-fill",
                color: [227, 139, 79, 0.8],
                outline: {
                  color: [255, 255, 255],
                  width: 1,
                },
              },
            });

            // Add the polygon graphic to the graphics layer
            graphicsLayer.add(polygonGraphic);

            // Add points to the map
            polygonCoordinates.forEach(function (pointCoords) {
              var point = new Point({
                x: pointCoords[0],
                y: pointCoords[1],
                spatialReference: { wkid: 3857 },
              });

              var pointGraphic = new Graphic({
                geometry: point,
                symbol: {
                  type: "simple-marker",
                  color: "blue",
                  size: "8px",
                },
              });

              graphicsLayer.add(pointGraphic);

              // Update the combined extent
              if (combinedExtent) {
                combinedExtent = combinedExtent.union(
                  polygonGraphic.geometry.extent
                );
              } else {
                combinedExtent = polygonGraphic.geometry.extent.clone();
              }
            });
          });
          // Zoom to the combined extent of all polygons
          if (combinedExtent) {
            view.goTo(combinedExtent);
          }
        }
        document
          .getElementById("upload-form")
          .addEventListener("submit", function (event) {
            event.preventDefault();
            var form = event.target;
            var formData = new FormData(form);

            fetch("/upload", {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((result) => {
                var resultDiv = document.getElementById("result");
                if (result.success) {
                  fetch("/polygons.json")
                    .then((response) => response.json())
                    .then((polygons) => {
                      console.log("Polygons loaded:", polygons); // Log the loaded polygons
                      addPolygonsAndPoints(polygons);
                    })
                    .catch((error) => {
                      console.error("Error loading polygons:", error);
                    });
                } else {
                  resultDiv.textContent = "File upload failed: " + result.error;
                  resultDiv.style.display = "block";
                }
              })
              .catch((error) => {
                console.error("Error uploading file:", error);
              });
          });
      });
    </script>
  </body>
</html>
